<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RWA Video Browser</title>
  <style>
    :root{--bg:#071428;--card:#0b2140;--muted:#9fb7d6;--accent:#6ad3ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg),#02101a);color:#e8f6ff}
    header{padding:18px;display:flex;gap:12px;align-items:center}
    h1{margin:0;font-size:18px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto;align-items:center}
    input,button,select{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:inherit}
    button{cursor:pointer}
    main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:18px}
    .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:12px;border-radius:12px;max-height:75vh;overflow:auto}
    .list-item{padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.01);cursor:pointer}
    .list-item:hover{outline:1px solid rgba(106,211,255,0.08)}
    .meta{font-size:12px;color:var(--muted)}
    .player-wrap{background:linear-gradient(180deg,#031226,#052035);padding:14px;border-radius:12px;min-height:300px}
    video{width:100%;height:420px;background:#000;border-radius:8px;outline:2px solid rgba(106,211,255,0.06)}
    .info{margin-top:12px}
    .small{font-size:13px;color:var(--muted)}
    .log{margin-top:12px;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;color:var(--muted);max-height:160px;overflow:auto}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
    .badge{background:rgba(106,211,255,0.06);padding:6px 8px;border-radius:999px;font-size:12px}
    label{display:flex;gap:6px;align-items:center}
  </style>
</head>
<body>
  <header>
    <h1>RWA Video Browser</h1>
    <div class="controls">
      <label class="badge">Using proxy: <input id="useProxy" type="checkbox" style="margin-left:8px" checked></label>
      <input id="proxyUrl" placeholder="Proxy hostname (optional)" value="https://studyverserwaproxy.vercel.app" style="min-width:260px">
      <input id="courseId" placeholder="course_id (e.g. 123)" style="min-width:140px">
      <input id="folderId" placeholder="parent folder_id (optional)" style="min-width:140px">
      <button id="loadBtn">Load Batches</button>
    </div>
  </header>

  <main>
    <aside class="sidebar">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
        <strong>Batches / Folders</strong>
        <small class="small">Click a folder to list videos</small>
      </div>
      <div id="list"></div>
    </aside>

    <section>
      <div class="player-wrap">
        <video id="player" controls crossorigin playsinline></video>
        <div class="info">
          <div id="title" style="font-weight:600">No video selected</div>
          <div id="meta" class="small">—</div>
        </div>
        <div class="log" id="log">Console / API logs will appear here.</div>
      </div>
    </section>
  </main>

  <footer>
    Endpoints used: <code>https://rozgarapinew.teachx.in/get/folder_contentsv2?course_id={course_id}&parent_id={folder_id}</code> and <code>https://rozgarapinew.teachx.in/get/fetchVideoDetailsById?course_id={course_id}&folder_wise_course=1&ytflag=0&video_id={fi}</code>
  </footer>

  <script>
    // ====== CONFIG (you gave these values) ======
    const DEFAULT_TOKEN = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpZCI6Ijc5ODczNTQiLCJlbWFpbCI6InNhbmp1c2hhcm1hMjg2OEBnbWFpbC5jb20iLCJ0aW1lc3RhbXBzIjoxNzQ0MTgwODg4LCJ0ZW5hbnRUeXBlIjoidXNlciIsInRlbmFhbnROYW1lIjoiIiwidGVuYW50SWQiOiIiLCJkaXNwb3NhYmxlIjpmYWxzZX0.E52O1aHYB8v3y8rx6EfSViMhCDriFOFofhCAW39molo';
    const API_BASE = 'https://rozgarapinew.teachx.in';

    // ====== DOM ======
    const listEl = document.getElementById('list');
    const player = document.getElementById('player');
    const logEl = document.getElementById('log');
    const titleEl = document.getElementById('title');
    const metaEl = document.getElementById('meta');

    document.getElementById('loadBtn').addEventListener('click', () => {
      const course_id = document.getElementById('courseId').value.trim();
      const parent_id = document.getElementById('folderId').value.trim();
      if(!course_id){
        appendLog('Enter a course_id first.');
        return;
      }
      fetchFolders(course_id, parent_id || 0);
    });

    function appendLog(...args){
      const line = document.createElement('div');
      line.textContent = args.map(a=>typeof a==='object'?JSON.stringify(a):a).join(' ');
      logEl.prepend(line);
    }

    function buildUrl(url){
      const useProxy = document.getElementById('useProxy').checked;
      const proxy = document.getElementById('proxyUrl').value.trim();
      if(useProxy && proxy){
        // proxy expects the target URL as /fetch?url=... or similar — the studyverserwaproxy provided by you should support forwarding.
        // We'll assume it forwards the final URL if appended as ?url=TARGET (common pattern). If your proxy uses a different scheme, change this.
        return proxy.replace(/\/+$/,'') + '/fetch?url=' + encodeURIComponent(url);
      }
      return url;
    }

    async function fetchFolders(course_id, parent_id = 0){
      const endpoint = `${API_BASE}/get/folder_contentsv2?course_id=${encodeURIComponent(course_id)}&parent_id=${encodeURIComponent(parent_id)}`;
      appendLog('Fetching folders:', endpoint);
      try{
        const res = await fetch(buildUrl(endpoint), {
          headers: {
            'Authorization': 'Bearer ' + DEFAULT_TOKEN,
            'Accept': 'application/json'
          }
        });
        const json = await res.json();
        appendLog('Folders response:', json);
        renderList(json, course_id);
      }catch(err){
        appendLog('Error fetching folders:', err);
      }
    }

    function clearList(){ listEl.innerHTML = ''; }

    function renderList(data, course_id){
      clearList();
      // We don't know exact response shape. Try a few likely fields.
      const items = data?.data || data?.items || data?.folders || data || [];
      if(!items || items.length===0){
        appendLog('No items found in response.');
        listEl.innerHTML = '<div class="small">No folders/videos returned.</div>';
        return;
      }

      items.forEach(it=>{
        const div = document.createElement('div');
        div.className = 'list-item';
        const name = it?.name || it?.title || it?.folder_name || it?.video_name || ('id:' + (it?.id || it?.video_id || it?.folder_id || 'unknown'));
        div.innerHTML = `<div style="font-weight:600">${escapeHtml(name)}</div><div class="meta">${escapeHtml(JSON.stringify(pickMeta(it)))}</div>`;
        div.addEventListener('click', ()=>{
          // If item represents a folder, drill into it. If it has video id, fetch video details.
          const possibleFolderId = it?.id || it?.folder_id || it?.parent_id || it?.parent;
          const possibleVideoId = it?.video_id || it?.id || it?.fi || it?.file_id || it?.fileid;
          // Heuristic: if the object has a type or is marked 'folder' or has 'children'
          if(it?.is_folder || it?.type==='folder' || (it?.children && it.children.length>0) || (it?.has_children)){
            appendLog('Drilling into folder id', possibleFolderId);
            // load that folder
            fetchFolders(course_id, possibleFolderId);
            return;
          }

          if(possibleVideoId){
            appendLog('Fetching video details for', possibleVideoId);
            fetchVideoDetails(course_id, possibleVideoId, it);
            return;
          }

          // If the response is a folder listing with nested videos array
          if(Array.isArray(it?.videos) && it.videos.length>0){
            renderList(it.videos, course_id);
            return;
          }

          appendLog('Item clicked but no folder/video id found for', it);
        });
        listEl.appendChild(div);
      });
    }

    function pickMeta(it){
      const meta = {};
      ['id','video_id','file_id','fi','folder_id','parent_id','size','duration'].forEach(k=>{ if(it?.[k]!==undefined) meta[k]=it[k]; });
      return meta;
    }

    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function fetchVideoDetails(course_id, video_id, originalItem){
      const endpoint = `${API_BASE}/get/fetchVideoDetailsById?course_id=${encodeURIComponent(course_id)}&folder_wise_course=1&ytflag=0&video_id=${encodeURIComponent(video_id)}`;
      appendLog('Calling video details:', endpoint);
      try{
        const res = await fetch(buildUrl(endpoint), {
          headers: {
            'Authorization': 'Bearer ' + DEFAULT_TOKEN,
            'Accept': 'application/json'
          }
        });
        const json = await res.json();
        appendLog('Video details response:', json);
        handleVideoResponse(json, originalItem || {});
      }catch(err){
        appendLog('Error fetching video details:', err);
      }
    }

    async function handleVideoResponse(json, originalItem){
      // The endpoint's shape is unknown; attempt to find a playable URL
      // Common places: json.url, json.data.url, json.data.file, json.stream, json.hls, json.video_url, json.playlist
      const soup = JSON.stringify(json).toLowerCase();
      const candidates = [];

      const probe = (obj, path='')=>{
        if(!obj) return;
        if(typeof obj==='string'){
          const val = obj;
          if(val.startsWith('http') && (val.includes('.m3u8') || val.includes('.mp4') || val.includes('cdn') || val.includes('http'))){
            candidates.push({path,val});
          }
        } else if(Array.isArray(obj)){
          obj.forEach((o,i)=>probe(o, path+'['+i+']'))
        } else if(typeof obj==='object'){
          Object.keys(obj).forEach(k=>probe(obj[k], path + '.' + k));
        }
      }
      probe(json);

      appendLog('Found candidate urls:', candidates.map(c=>c.val));

      // prefer m3u8
      let picked = candidates.find(c=>c.val.includes('.m3u8')) || candidates.find(c=>c.val.includes('.mp4')) || candidates[0];
      if(!picked){
        appendLog('No direct URL found. Inspect the response above to see where the stream lives.');
        titleEl.textContent = 'No playable URL found';
        metaEl.textContent = JSON.stringify(json);
        return;
      }

      const url = picked.val;
      titleEl.textContent = originalItem?.name || originalItem?.title || (json?.title || json?.name) || ('Video: ' + video_idFrom(url));
      metaEl.textContent = `source: ${picked.path}`;

      // If m3u8 and browser doesn't support HLS natively, load hls.js
      if(url.includes('.m3u8')){
        setupHls(url);
      } else {
        // assume mp4 or playable resource
        detachHls();
        player.src = url;
        player.load();
        player.play().catch(()=>{});
      }
    }

    // Simple HLS support using hls.js loaded dynamically
    let hlsScript = null;
    let hlsInstance = null;
    function detachHls(){
      if(hlsInstance && hlsInstance.destroy){ try{ hlsInstance.destroy(); }catch(e){} }
      hlsInstance = null;
      if(player){ player.src = ''; }
    }

    async function setupHls(url){
      // If browser canPlayType for m3u8 (Safari) then just set
      if(player.canPlayType('application/vnd.apple.mpegurl')){
        detachHls();
        player.src = url;
        player.load();
        player.play().catch(()=>{});
        appendLog('Using native HLS playback (Safari).');
        return;
      }

      // load hls.js if not present
      if(typeof Hls === 'undefined'){
        appendLog('Loading hls.js from CDN...');
        await loadScript('https://cdn.jsdelivr.net/npm/hls.js@latest');
      }

      if(typeof Hls !== 'undefined'){
        try{
          detachHls();
          hlsInstance = new Hls();
          hlsInstance.loadSource(url);
          hlsInstance.attachMedia(player);
          hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
            player.play().catch(()=>{});
          });
          appendLog('hls.js attached and playing.');
        }catch(err){
          appendLog('hls.js error:', err);
        }
      } else {
        appendLog('hls.js failed to load.');
      }
    }

    function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src; s.async = true;
        s.onload = ()=> resolve();
        s.onerror = (e)=> reject(e);
        document.head.appendChild(s);
      });
    }

    function video_idFrom(u){ try{ return u.split('/').pop().split('?')[0]; }catch(e){return 'unknown'} }

    // Auto-fill an example course_id (optional)
    // document.getElementById('courseId').value = 'your_course_id_here';

    // Helpful note for you: if the proxy you gave uses a different path (not /fetch?url=), adjust buildUrl()
  </script>
</body>
</html>
